# Edit this file when you want changes to the nginx gate config - it's the basis for gateway-autogenerated
# Don't edit gateway-autogenerated manually.

# SOME GENERAL CONFIGS
ssl_session_cache shared:SSL:10m;
ssl_session_timeout 10m;

#Â USE PRIVATE IP ADDRESSES FOR THE CLUSTER MACHINES
# MAKE SURE THE IP ADDRESSES USED HERE MATCH THOSE LISTED IN THE FILES IN THE IPS FOLDER

# THE MACHINES THAT RUN THE APPS
upstream apps {
    ip_hash;
    #server 10.131.21.233; # doaj-app-2
    server 10.131.168.173; # doaj-app-1
}

upstream testapps {
    ip_hash;
    server 10.131.178.96;
}

# UPSTREAM_STAGING_APPS_SECTION

# THE MACHINES ON WHICH ELASTICSEARCH CLUSTER IS ACCEPTING INPUT
# APPS THAT CALL IT "DIRECTLY" SHOULD CALL THIS GATEWAY MACHINE AND THEN THIS ROUTES TO THE INDEX
include includes/upstream-index-production.conf;

upstream testindex {
    server 10.131.178.96:9200;
}

# UPSTREAM_STAGING_INDEX_SECTION

# THE INDEX - GATEWAY UFW SHOULD ALLOW ALL APPS MACHINES TO CALL 9200 VIA ETH1
# WHICH MATCHES THIS, WHICH PASSES THROUGH TO THE INDEX UPSTREAM CLUSTER MACHINES
server {
    listen          9200;
    server_name     gateway;

    location /_snapshot {
        proxy_pass http://index;
        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_buffering off;
    }

    location / {
        client_max_body_size 1024M;
        proxy_connect_timeout 3s;
        proxy_read_timeout 15s;

        proxy_pass http://index;
        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_buffering off;
    }
}

# Redirect to SSL wherever necessary
server {
    listen          80;
    server_name     doajgate.cottagelabs.com testdoajes.cottagelabs.com monitordoaj.cottagelabs.com;

    location ~ /.well-known {
        root /usr/share/nginx/html/;
        allow all;
    }

    return 301 https://$host$request_uri;
}

# AN HTTPS ENDPOINT FOR ES THAT IS SECURED WITH BASIC AUTH
# SO ELASTICSEARCH HEAD CAN BE VIEWED IF NECESSARY
# SHOULD EVENTUALLY REWRITE THROUGH THE INDEX APP
server {
    listen          443 ssl;
    server_name     doajgate.cottagelabs.com;

    auth_basic "Restricted";
    auth_basic_user_file /etc/nginx/htpasswd;

    include includes/cl-letsencrypt-doaj.conf;

    location ~ /.well-known {
        auth_basic off;
        root /usr/share/nginx/html/;
        allow all;
    }

    location / {
        proxy_pass http://index;
        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Authorization "";
    }
}

server {
    listen          443 ssl;
    server_name     monitordoaj.cottagelabs.com;

    auth_basic "Restricted";
    auth_basic_user_file /etc/nginx/htpasswd;

    include includes/cl-letsencrypt-doaj.conf;

    location ~ /.well-known {
        auth_basic off;
        root /usr/share/nginx/html/;
        allow all;
    }

    location / {
        proxy_pass http://10.131.137.108:9200;
        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Authorization "";
    }

    location =/kibana {
        return 301 /_plugin/marvel/kibana/index.html;
    }
}

server {
    listen          443 ssl;
    server_name     testdoajes.cottagelabs.com;

    auth_basic "Restricted";
    auth_basic_user_file /etc/nginx/test_doaj_es_htpasswd;

    include includes/cl-letsencrypt-doaj.conf;

    location ~ /.well-known {
        auth_basic off;
        root /usr/share/nginx/html/;
        allow all;
    }

    location / {
        proxy_pass http://testindex;
        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Authorization "";
    }
}
