<!DOCTYPE html>
<html dir="ltr" lang="en">
<head>
  <meta charset="utf-8">
  <title>{{ name }} - DOAJ Testdrive</title>
  <meta name="description" content="Testdrive setup results for {{ name }}">
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1">
</head>
<body>

<h1>{{ name }} - Testdrive setup results</h1>

{%- macro render_dict(d) %}
    <dl>
        {% for k, v in d.items() %}
            <dt>{{ k }}</dt>
            <dd>
                {% if v is mapping %}
                    {{ render_dict(v) }}
                {% elif v is iterable and v is not string and v is not mapping %}
                    <ul>
                        {% for item in v %}
                            <li>
                                {% if item is mapping %}
                                    {{ render_dict(item) }}
                                {% else %}
                                    {{ item }}
                                {% endif %}
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    {% if v.startswith("http") %}<a href="{{ v }}" target="_blank">{% endif %}{{ v }}{% if v.startswith("http") %}</a>{% endif %}
                {% endif %}
            </dd>
        {% endfor %}
    </dl>
{% endmacro -%}

{%- for k, v in params.items() %}
    {% if k != "teardown" and k != "non_renderable" and k!= "script" %}
    <h2>{{ k }}</h2>
    <dl>
    {% if v is mapping %}
        {{ render_dict(v) }}
{#        {% for k1, v1 in v.items() %}#}
{#            <dt>{{ k1 }}</dt>#}
{#            <dd>#}
{#                {% if v1 is iterable and (v1 is not string and v1 is not mapping) %}#}
{#                    {{ v1 }}#}
{#                {% else %}#}
{#                    {% if v1.startswith("http") %}<a href="{{ v1 }}" target="_blank">{% endif %}{{ v1 }}{% if v1.startswith("http") %}</a>{% endif %}</dd>#}
{#                {% endif %}#}
{#        {% endfor %}#}
    {% elif v is iterable %}
        <dt>list of values:</dt>
        <dd><ul>
        {% for v1 in v %}
            <li>
            {% if v1 is mapping %}
                {{ render_dict(v1) }}
            {% else %}
                {% if v1.startswith("http") %}<a href="{{ v1 }}" target="_blank">{% endif %}{{ v1 }}{% if v1.startswith("http") %}</a>{% endif %}
            {% endif %}
            </li>
        {% endfor %}
        </ul></dd>
    {% endif %}
    </dl>
    {% endif %}
{% endfor -%}

{% if "script" in params %}
 <script>
    const scriptData = {{ params['script'] | tojson }};
</script>
<style>
    .script-btn {
        background: white;
        border: darkgray 1px solid;
        padding: .5rem 1rem;
        cursor: pointer;
    }
    .script-btn:hover {
        box-shadow:
        inset 1px 1px 2px rgba(0, 0, 0, 0.3),
        inset -1px -1px 2px rgba(255, 255, 255, 0.5);
        transition: box-shadow 0.2s ease;
    }
    .loading::after {
        display: inline-block;
        animation: dots 1.5s infinite step-end;
        content: '';
        width: 0;
    }
    @keyframes dots {
        0%, 20% { content: ''; }
        40% { content: '.'; }
        60% { content: '..'; }
        80%, 100% { content: '...'; }
    }
    .loading { opacity: 0.7; }
</style>
<button class="script-btn" id="script_btn" onclick="sendPost(scriptData)">
    {{ params['script']['title'] | default('Run script') }}
</button>
<script>
function sendPost() {
    const btn = document.getElementById('script_btn');
    btn.disabled = true;
    btn.classList.add('loading');
    btn.textContent = 'Loading';
    const scriptBtn = document.getElementById('script_btn');
    fetch('/testdrive/run', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ script_name: scriptData.script_name })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Request failed');
        }
        return response.json();  // Or .text() if server returns plain text
    })
    .then(data => {
        console.log('Success:', data);

        if (scriptBtn) {
            scriptBtn.insertAdjacentHTML('afterend', '<p>Script executed successfully!</p>');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        if (scriptBtn) {
            scriptBtn.insertAdjacentHTML('afterend', '<p>Something went wrong :(</p>');
        }
    })
    .finally(() => {
        btn.disabled = false;
        btn.classList.remove('loading');
        btn.textContent = scriptData.title || 'Run script';  // Reset text
    });;
}
</script>
{% endif %}

<h1>Teardown</h1>

<p>When you have finished your test, you can cleanup the test resources from the test system by clicking this link</p>

<a href="{{ params.teardown }}">{{ params.teardown }}</a>

</body>
</html>