{% extends "public/base.html" %}

{% block page_title %}Application form{% endblock %}
{% block body_id %}apply{% endblock %}

{% set form_id = "new_form" %}
{% set form_action = url_for("apply.public_application") %}
{% set formulaic_after = url_for("apply.application_thanks") %}
{% if obj %}
{% set form_action = url_for("apply.public_application", draft_id=obj.id) %}
{% endif %}

{% set js_validation = True %}
{% set auto_save = config.get("PUBLIC_FORM_AUTOSAVE", 0) %}
{% set TAB1 = {"title": _("Open access compliance"), "fieldsets": ["basic_compliance"]} %}
{% set TAB2 = {"title": _("About the Journal"), "fieldsets": ["about_the_journal", "publisher", "society_or_institution"]} %}
{% set TAB3 = {"title": _("Copyright & licensing"), "fieldsets": ["licensing", "embedded_licensing", "copyright"]} %}
{% set TAB4 = {"title": _("Editorial"), "fieldsets": ["peer_review", "plagiarism", "editorial"]} %}
{% set TAB5 = {"title": _("Business model"), "fieldsets": ["apc", "apc_waivers", "other_fees"]} %}
{% set TAB6 = {"title": _("Best practice"), "fieldsets": ["archiving_policy", "deposit_policy", "unique_identifiers"]} %}
{% set FORM = [TAB1, TAB2, TAB3, TAB4, TAB5, TAB6] %}


{% block public_content scoped %}
<div class="container">
    {% include "_application-form/includes/_backend_validation.html" %}
    <div class="row">
        <div class="col-md-8">
            <section class="page-content">
                <form id="{{ form_id }}"
                      data-context="{{ formulaic_context.name }}"
                      class="application_form"
                      novalidate
                      action="{{ form_action }}"
                      method="post"
                      data-formulaic-after="{{ formulaic_after }}">

                    {% include "_application-form/includes/_public_fieldsets.html" %}

                    <div class="tab form-section">
                        {% include "public/_application-form/includes/_review.html" %}
                    </div>
                    <p class="alert alert--danger" id="cannot-submit-invalid-fields" style="display: none">
                        You cannot submit the application because it contains some invalid fields. Please review your
                        answers and try again.
                    </p>
                    {% include "public/_application-form/includes/_buttons.html" %}

                    {% if obj %}
                    <input type="hidden" name="id" value="{{ obj.id }}">
                    {% elif draft_data %}
                    <input type="hidden" name="id" value="{{ draft_data.id }}">
                    {% endif %}
                </form>
            </section>
        </div>

        <div class="col-md-4">
            <div class="language-selector">
                <form action="/apply/" method="GET" id="language_form">
                    <select id="languageSelect" name="lang" onchange="$(this.form).trigger('submit')">
                        <option value="en" {% if session.get(
                        'lang') == 'en' %}selected{% endif %}>English</option>
                        <option value="fr" {% if session.get(
                        'lang') == 'fr' %}selected{% endif %}>Fran√ßais</option>
                    </select>
                </form>
            </div>
            <div>
                {% include "public/_application-form/includes/_pagination_menu.html" %}
            </div>
            <div class="row">
                {% include "public/_application-form/includes/_aside_menu.html" %}
            </div>
        </div>
    </div>
</div>
<!-- Modal -->

<div id="warningModal" class="modal" style="display: none;" role="dialog">
    <div class="modal__dialog" style="height: max-content">
        <p>You are about to change the form language. Any unsaved changes may be lost. To keep your changes, close this
            message and click the "Save Draft" button at the bottom of the page.
        </p>
        <button id="stayBtn" style="margin-right:10px;">Cancel</button>
        <button id="leaveBtn">Submit Anyway</button>
    </div>
</div>

{% endblock %}

{% block public_js scoped %}
{% include "_application-form/includes/_form_js.html" %}
<script type="text/javascript" src="/static/js/change_language_alert.js"></script>
<script>
    doaj.lang_change.init({containerSelector: "#new_form", submitSelector: "#language_form", warningModal: "#warningModal"});
</script>
{% endblock %}
