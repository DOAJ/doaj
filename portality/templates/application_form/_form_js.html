<script type="text/javascript" src="/static/vendor/parsley-2.9.2/parsley.min.js?v={{config.get('DOAJ_VERSION')}}"></script>
<script type="text/javascript" src="/static/vendor/edges/src/edges.js?v={{config.get('DOAJ_VERSION')}}"></script>
<!-- get select2 -->
<script type="text/javascript" src="/static/vendor/select2-3.5.4/select2.min.js?v={{config.get('DOAJ_VERSION')}}"></script>
<link rel="stylesheet" type="text/css" href="/static/vendor/select2-3.5.4/select2.css">
<link href='/static/doaj/css/application_form.css' media='screen' rel='stylesheet' type='text/css' />
<script type="text/javascript" src="/static/js/formulaic.js?v={{config.get('DOAJ_VERSION')}}"></script>
<script type="text/javascript">
    jQuery(document).ready(function($) {
        formulaic.active = formulaic.newFormulaic({
            formSelector: "#{{ form_id }}",
            functions : {{ formulaic_context.javascript_functions|tojson }},
            doValidation : {% if js_validation %}true{% else %}false{% endif %},
            autoSave: {{ auto_save }},
            fieldsets : {{ formulaic_context.ui_settings|tojson }}
        });

    });

    window.Parsley.addValidator("requiredIf", {
        validateString : function(value, requirement, parsleyInstance) {
            let field = parsleyInstance.$element.attr("data-parsley-required-if-field");
            if ($('[name="' + field + '"]').filter(':checked').val() === requirement){
                return !!value;
            }
            return true;
        },
        messages: {
            en: 'This field is required, because you answered "%s" to the previous question.'
        },
        priority: 33
    })

    window.Parsley.addValidator("requiredvalue", {
        validateString : function(value, requirement) {
            return (value === requirement);
        },
        messages: {
            en: 'DOAJ only indexed open access journals which comply with the statement above. Please check and update the open access statement of your journal. You may return to this application at any time.'
        },
        priority: 32
    })

    window.Parsley.addValidator("optionalIf", {
        validateString : function(value, requirement) {
            theOtherField = $("[name = " + requirement + "]")
            if (!!value || !!($(theOtherField)).val()) {
                $(theOtherField).parsley().reset()
                return true;
            }
            return false;
        },
        messages: {
            en: 'You need to provide the answer to either this field or %s field (or both)'
        },
        priority: 1
    })

    window.Parsley.addValidator("differentTo", {
        validateString : function(value, requirement) {
          return (!value || ($("[name = " + requirement + "]")).val() !== value)
        },
        messages: {
            en: 'Value of this field and %s field must be different'
        },
        priority: 1
    })

    let showTab = (n) => {
        // This function will display the specified tab of the form ...
        //hide all other tabs
        if (n < sections.length-1){
            let hiddenField = $("#validated-" + n)
            if (hiddenField.val() === "") {
                hiddenField.val("False");
            }
        }

        tabs.each((idx, tab) => {
            $(tab).hide();
        });

        let submitButton = $("#submitBtn");
        let draftButton = $("#draftBtn");
        $(tabs[n]).show();
        $("#cannot_save_draft").hide();
        submitButton.hide();
        draftButton.show();
        // ... and fix the Previous/Next buttons:
        if (n === 0) {
            $("#prevBtn").hide();
        } else {
            $("#prevBtn").show();
        }

        if (n === (tabs.length - 1)) {
            //show submit button only if all tabs are validated
            $("#nextBtn").hide();
            submitButton.show();
            draftButton.show();
            let validated = form_validated();
            if (!validated) {
                $("#cannot-submit-invalid-fields").show();
            } else {
                $("#cannot-submit-invalid-fields").hide();
            }

        } else {
            let nextBtn = $("#nextBtn")
            nextBtn.show();
            nextBtn.html("Next");
            submitButton.hide();
            draftButton.show();
            submitButton.prop("disabled",false);
        }
        currentTab = n;
        previousTab = n-1;
        // ... and run a function that displays the correct step indicator:
        if(n === 6) {
            $("#validated-6").val("True");
            prepareReview()
        }
        fixStepIndicator(n)
        window.scrollTo(0,0);

    }

    let prepareReview = () => {
        let review_values = $("td[id$='__review_value']")
        review_values.each((idx, question) => {
            let id = $(question).attr('id')
            {#let validationResult = parsleyForm.fields[i].validationResult;#}
            {#if (validationResult !== true){#}
            if (id === "apc_charges__review_value") {
                let currency = $("select[id$='apc_currency']");
                let max = $("input[id$='apc_max']");
                let result = ""
                let isValid = true;
                for (let i = 0; i < currency.length; i++){
                    let curr = $(currency[i]).find('option:selected').text()
                    let m = $(max[i]).val()
                    if (m !== "" || curr !== "") {
                        result += (m === "" ? "" : m) + " " + (curr === "" ? "" : curr) + " " + "<br>";
                    }
                }
                if ($(max[0]).parsley().validationResult !== true || ($(currency[0]).parsley().validationResult !== true)) {
                    isValid = false;
                }
                if (result === "" && isValid){
                    $(question).parent().hide();
                }
                else {
                    $(question).parent().show();
                    $(question).html(result);
                }
            }
            else {
                let name = id.substring(0, id.indexOf("__review_value"));
                let input = $("input[name='" + name + "']");
                if (input.length === 0) {  //it's not input but select
                    input = $("[name^='" + name + "']");
                    let result = "";
                    input.each((idx, inp) => {
                        let val = $(inp).find('option:selected').text();
                        if (val !== "") {
                            result += val + "<br>";
                        }

                    })
                    $(question).html(result);
                } else {
                    if (id === "keywords__review_value") {
                        let result = "";
                        let this_input = $('#keywords')
                        let keywords = this_input.val().split(",")
                        if (keywords.length !== 1) {
                            $(keywords).each((idx, kw) => {
                                result += kw + "<br>";
                            });
                        }
                        else {
                            result = keywords[0];
                        }
                        $(question).html(result);


                    } else {
                        if ($(input).attr("data-parsley-required-if") !== undefined) {
                            if (input.val() === "" && $(input).parsley().validationResult === true){
                                $(question).parent().hide();
                                return;
                            }
                            else {
                                $(question).parent().show();
                            }
                        }
                        let type = input.attr("type");
                        if (type === "text" || type === "number") {
                            $(question).html(input.val())
                        } else if (type === "url") {
                            $(question).html('<a href=' + input.val() + '>' + input.val() + '</a>')
                        } else if (type === "radio") {
                            if (input.is(":checked")) {
                                let text = $('label[for=' + $(input.filter(':checked')).attr('id') + ']').text();
                                $(question).html(text);
                            }
                        } else if (type === "checkbox") {
                            let result = ''
                            input.each((idx, i) => {
                                if ($(i).is(":checked")) {
                                    let text = $('label[for=' + $(i).attr('id') + ']').text();
                                    result += text + "<br>";
                                }
                            })
                            $(question).html(result)
                        }
                    }
                }
            }

        })
    }

    let form_validated = () => {
        let result = true;
        let inputs = $("[name^='validated']");
        $(inputs).each((idx, input) => {
            if (idx === inputs.length-1) {
                return result;
            }
            if ($(input).val() !== "True") {
                result = false;
                return;
            }
        });
        return result;
    }

    let next = () => {
        navigate(currentTab + 1);
    }

    let prev = () => {
        navigate(currentTab - 1, true);
    }

    let submitaplication = () => {
        let form = $("form");
        let parsleyForm = $(form).parsley()
        $(form).submit();

    }

    let savedraft = () => {
        let form = $(".application_form");
        $(form).attr('novalidate', 'novalidate');
        let input = $("<input>")
               .attr("type", "hidden")
               .attr("name", "draft").val(true);
        let input2 = $("<input>")
               .attr("type", "hidden")
               .attr("name", "draft_id").val($(form).attr("id"));
        form.append($(input));
        form.append($(input2));
        let parsleyForm = $(form).parsley()
        parsleyForm.validate()
        let result = true;

        for (let i = 0; i < parsleyForm.fields.length; i++){
            let validationResult = parsleyForm.fields[i].validationResult;
            if (validationResult !== true){
                if (validationResult[0].assert.name !== 'required'){
                    $("#cannot_save_draft").show();
                    result = false;
                    break;

                }
            }
        }
        if (result) {
            $(form).off('form:validate');
            $("#cannot_save_draft").hide();
            parsleyForm._submit();
        }
    }

    let navigate = (n, showEvenIfInvalid = false) => {
        // Hide the current tab:
        var form = $('#' + '{{ form_id }}');
        form.parsley().whenValidate({
            group: 'block-' + currentTab
        }).done(function () {
            $("#validated-" + currentTab).val("True");
            previousTab = n-1
            currentTab = n;
            // Otherwise, display the correct tab:
            showTab(currentTab);
        }).fail(function () {
            $("#validated-" + currentTab).val("False");
            if (showEvenIfInvalid){
                previousTab = n-1
                currentTab = n;
                // Otherwise, display the correct tab:
                showTab(currentTab);
            }

        });
    }


    let fixStepIndicator = (n) => {
        // This function removes the "active" class of all steps...
        $(".application-nav__list-item").each((idx, x) => {
            let hiddenField = $("#validated-" + idx);
            if (idx === n) {
                x.className = "application-nav__list-item application-nav__list-item--active";
            }
            else {
                if (hiddenField.val() === "True") {
                    x.className = "application-nav__list-item application-nav__list-item--done";
                } else if (hiddenField.val() === "False") {
                    x.className = "application-nav__list-item application-nav__list-item--invalid";
                }
                else {
                    x.className = "application-nav__list-item";
                }
            }
        });
        //... and adds the "active" class to the current step:

        $("#page_link-" + n).className = "page_link";
    }

    let usePaginationMenu = () => {
        $('[id^="page_link-"]').each((i, x) => {
            $(x).on("click", () => {
                if ($("#validated-" + i).val() === '') {
                    //dev only!
                    //navigate(i);
                    return false;
                } else {
                    navigate(i, true);
                }

            });
        });
    }

    let prepareSections = () => {
        sections.each((idx, section) => {

            $(section).find("input, select").each((i, input) => {
                $(input).attr('data-parsley-group', 'block-' + idx);
            });

            if (idx < sections.length){
                let hiddenInputs = $("[name='validated']");
                $(hiddenInputs[idx]).attr('id', 'validated-' + idx);
            }

        });

        $('[id^="page_link-"]').each((i, menu) =>  {
            $(menu).className = "page_link--disabled";
        });
    }

    let manage_review_checkboxes = () => {
        if ($("#reviewed").prop("checked")){
            $("#cannot-submit-checkboxes").hide();
            $("#submitBtn").prop("disabled", !form_validated());
        } else {
            $("#cannot-submit-checkboxes").show();
            $("#submitBtn").prop("disabled", true);
        }
    }

    $("#reviewed").on("click", manage_review_checkboxes);

    let currentTab = 0; // Current tab is set to be the first tab (0)
    let previousTab = 0;
    let tabs = $(".tab");
    let sections = $(".form-section");
    prepareSections();
    usePaginationMenu();
    showTab(currentTab); // Display the current tab
    {#$("#submitBtn").on("click",onSubmit);#}
    {#$("#draftBtn").on("click", saveDraft);#}

</script>
